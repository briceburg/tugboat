// Generated by CoffeeScript 1.8.0
var init_errors, seq;

seq = require('../src/seq');

init_errors = require('./errors');

module.exports = function(tugboat, groupnames, usecache) {
  return tugboat.init(function(errors) {
    var group, haderror, name, _i, _j, _len, _len1, _results;
    if (errors != null) {
      return init_errors(errors);
    }
    console.log();
    if (Object.keys(tugboat._groups).length === 0) {
      console.error('  There are no groups defined in this directory'.magenta);
      console.error();
      process.exit(1);
    }
    if (groupnames.length === 0) {
      groupnames = Object.keys(tugboat._groups);
    }
    groupnames = groupnames.map(function(g) {
      return g.replace('.yml', '');
    });
    haderror = false;
    for (_i = 0, _len = groupnames.length; _i < _len; _i++) {
      name = groupnames[_i];
      if (tugboat._groups[name] == null) {
        console.error(("  The group '" + name + "' is not available in this directory").red);
        console.error();
        haderror = true;
      }
    }
    if (haderror) {
      process.exit(1);
    }
    _results = [];
    for (_j = 0, _len1 = groupnames.length; _j < _len1; _j++) {
      name = groupnames[_j];
      group = tugboat._groups[name];
      _results.push((function(name, group) {
        return seq(function(cb) {
          var config, servicename, _fn, _ref;
          seq(function(cb) {
            console.log("  Building " + name.blue + "...");
            console.log();
            return cb();
          });
          _ref = group.services;
          _fn = function(servicename, config) {
            var output;
            if (config.build == null) {
              return;
            }
            output = servicename.cyan;
            while (output.length < 36) {
              output += ' ';
            }
            return seq(output, function(cb) {
              var results, run;
              results = '';
              run = function(message) {
                results += message;
                return results += '\n';
              };
              return tugboat.build(group, config, usecache, run, function(err) {
                if (err != null) {
                  if (results.length !== 0) {
                    console.error(results);
                  }
                  return cb(err);
                }
                return cb();
              });
            });
          };
          for (servicename in _ref) {
            config = _ref[servicename];
            _fn(servicename, config);
          }
          seq(function(cb) {
            console.log();
            return cb();
          });
          return cb();
        });
      })(name, group));
    }
    return _results;
  });
};
